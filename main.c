#include "sam.h"
#include "timer.h"
#include "counter.h"
#include "event.h"
#include "spi.h"
#include "led.h"
#include "buttons.h"

#define RED (0)
#define YELLOW (1)
#define GREEN (2)
#define CYAN (3)
#define BLUE (4)
#define MAGENTA (5)

static volatile uint32_t millis;

// LED values
const uint16_t fade_up[360] = {
	0, 11, 23, 34, 46, 57, 69, 80, 92, 103,
	115, 126, 138, 149, 161, 172, 184, 195, 207, 218,
	230, 241, 253, 264, 276, 287, 299, 310, 322, 333,
	345, 356, 368, 379, 391, 402, 414, 425, 437, 448,
	460, 471, 483, 494, 506, 517, 529, 540, 552, 563,
	575, 586, 598, 609, 621, 632, 644, 655, 667, 678,
	690, 701, 713, 724, 736, 747, 759, 770, 782, 793,
	805, 816, 828, 839, 851, 862, 874, 885, 897, 908,
	920, 931, 943, 954, 966, 977, 989, 1000, 1012, 1023,
	1035, 1046, 1058, 1069, 1081, 1092, 1104, 1115, 1127, 1138,
	1150, 1161, 1173, 1184, 1196, 1207, 1219, 1230, 1242, 1253,
	1265, 1276, 1288, 1299, 1311, 1322, 1334, 1345, 1357, 1368,
	1380, 1391, 1403, 1414, 1426, 1437, 1449, 1460, 1472, 1483,
	1495, 1506, 1518, 1529, 1541, 1552, 1564, 1575, 1587, 1598,
	1610, 1621, 1633, 1644, 1656, 1667, 1679, 1690, 1702, 1713,
	1725, 1736, 1748, 1759, 1771, 1782, 1794, 1805, 1817, 1828,
	1840, 1851, 1863, 1874, 1886, 1897, 1909, 1920, 1932, 1943,
	1955, 1966, 1978, 1989, 2001, 2012, 2024, 2035, 2047, 2058,
	2070, 2081, 2093, 2104, 2116, 2127, 2139, 2150, 2162, 2173,
	2185, 2196, 2208, 2219, 2231, 2242, 2254, 2265, 2277, 2288,
	2300, 2311, 2323, 2334, 2346, 2357, 2369, 2380, 2392, 2403,
	2415, 2426, 2438, 2449, 2461, 2472, 2484, 2495, 2507, 2518,
	2530, 2541, 2553, 2564, 2576, 2587, 2599, 2610, 2622, 2633,
	2645, 2656, 2668, 2679, 2691, 2702, 2714, 2725, 2737, 2748,
	2760, 2771, 2783, 2794, 2806, 2817, 2829, 2840, 2852, 2863,
	2875, 2886, 2898, 2909, 2921, 2932, 2944, 2955, 2967, 2978,
	2990, 3001, 3013, 3024, 3036, 3047, 3059, 3070, 3082, 3093,
	3105, 3116, 3128, 3139, 3151, 3162, 3174, 3185, 3197, 3208,
	3220, 3231, 3243, 3254, 3266, 3277, 3289, 3300, 3312, 3323,
	3335, 3346, 3358, 3369, 3381, 3392, 3404, 3415, 3427, 3438,
	3450, 3461, 3473, 3484, 3496, 3507, 3519, 3530, 3542, 3553,
	3565, 3576, 3588, 3599, 3611, 3622, 3634, 3645, 3657, 3668,
	3680, 3691, 3703, 3714, 3726, 3737, 3749, 3760, 3772, 3783,
	3795, 3806, 3818, 3829, 3841, 3852, 3864, 3875, 3887, 3898,
	3910, 3921, 3933, 3944, 3956, 3967, 3979, 3990, 4002, 4013,
	4025, 4036, 4048, 4059, 4071, 4082, 4095};
	
const uint16_t fade_down[360] = {
	4095, 4082, 4071, 4059, 4048, 4036, 4025, 4013, 4002, 3990,
	3979, 3967, 3956, 3944, 3933, 3921, 3910, 3898, 3887, 3875,
	3864, 3852, 3841, 3829, 3818, 3806, 3795, 3783, 3772, 3760,
	3749, 3737, 3726, 3714, 3703, 3691, 3680, 3668, 3657, 3645,
	3634, 3622, 3611, 3599, 3588, 3576, 3565, 3553, 3542, 3530,
	3519, 3507, 3496, 3484, 3473, 3461, 3450, 3438, 3427, 3415,
	3404, 3392, 3381, 3369, 3358, 3346, 3335, 3323, 3312, 3300,
	3289, 3277, 3266, 3254, 3243, 3231, 3220, 3208, 3197, 3185,
	3174, 3162, 3151, 3139, 3128, 3116, 3105, 3093, 3082, 3070,
	3059, 3047, 3036, 3024, 3013, 3001, 2990, 2978, 2967, 2955,
	2944, 2932, 2921, 2909, 2898, 2886, 2875, 2863, 2852, 2840,
	2829, 2817, 2806, 2794, 2783, 2771, 2760, 2748, 2737, 2725,
	2714, 2702, 2691, 2679, 2668, 2656, 2645, 2633, 2622, 2610,
	2599, 2587, 2576, 2564, 2553, 2541, 2530, 2518, 2507, 2495,
	2484, 2472, 2461, 2449, 2438, 2426, 2415, 2403, 2392, 2380,
	2369, 2357, 2346, 2334, 2323, 2311, 2300, 2288, 2277, 2265,
	2254, 2242, 2231, 2219, 2208, 2196, 2185, 2173, 2162, 2150,
	2139, 2127, 2116, 2104, 2093, 2081, 2070, 2058, 2047, 2035,
	2024, 2012, 2001, 1989, 1978, 1966, 1955, 1943, 1932, 1920,
	1909, 1897, 1886, 1874, 1863, 1851, 1840, 1828, 1817, 1805,
	1794, 1782, 1771, 1759, 1748, 1736, 1725, 1713, 1702, 1690,
	1679, 1667, 1656, 1644, 1633, 1621, 1610, 1598, 1587, 1575,
	1564, 1552, 1541, 1529, 1518, 1506, 1495, 1483, 1472, 1460,
	1449, 1437, 1426, 1414, 1403, 1391, 1380, 1368, 1357, 1345,
	1334, 1322, 1311, 1299, 1288, 1276, 1265, 1253, 1242, 1230,
	1219, 1207, 1196, 1184, 1173, 1161, 1150, 1138, 1127, 1115,
	1104, 1092, 1081, 1069, 1058, 1046, 1035, 1023, 1012, 1000,
	989, 977, 966, 954, 943, 931, 920, 908, 897, 885,
	874, 862, 851, 839, 828, 816, 805, 793, 782, 770,
	759, 747, 736, 724, 713, 701, 690, 678, 667, 655,
	644, 632, 621, 609, 598, 586, 575, 563, 552, 540,
	529, 517, 506, 494, 483, 471, 460, 448, 437, 425,
	414, 402, 391, 379, 368, 356, 345, 333, 322, 310,
	299, 287, 276, 264, 253, 241, 230, 218, 207, 195,
	184, 172, 161, 149, 138, 126, 115, 103, 92, 80,
	69, 57, 46, 34, 23, 11, 0};

int main(void)
{
	uint8_t color = RED;
	uint8_t mode = 0;
	uint16_t index = 0;
	uint16_t red, green, blue;
	uint8_t step = 6;

	// Initialize the SAM system 
	SystemInit();
	SysTick_Config(48000); //  Configure the SysTick timer for 1 ms

	// Initialize drivers
	led_init();
	timer_init();
	counter_init();
	spi_init();
	event_init();
	
	// Turn on the timer and the counter
    timer_enable();
	counter_enable();
	led_writeAll(0, 0, 0);
	spi_write();

	while (1)
	{	
		if (mode == 0)
		{
			if (counter_flagGet()) // if flag set
			{
				counter_flagSet(0); // clear flag
				switch (color)
				{
					case RED: // fade to yellow
						red = 4095;
						green = fade_up[index];
						blue = 0;
						break;
					
					case YELLOW: // fade to green
						red = fade_down[index];
						green = 4095;
						blue = 0;
						break;
					
					case GREEN: // fade to cyan
						red = 0;
						green = 4095;
						blue = fade_up[index];
						break;
					
					case CYAN:
						red = 0; // fade to blue
						green = fade_down[index];
						blue = 4095;
						break;
					
					case BLUE: // fade to magenta
						red = fade_up[index];
						green = 0;
						blue = 4095;
						break;
					
					case MAGENTA: // fade to red
						red = 4095;
						green = 0;
						blue = fade_down[index];
						break;
					
					default:
						red = 0;
						green = 0;
						blue = 0;
						break;
				}
				led_writeAll(red, green, blue);
				spi_write(); // send first spi write
				index += step; // step thru table
				if (index >= 360) // if table has been stepped through completely
				{
					index = 0; // reset index
					color += 1; // increment color state
					if (color > 5) // after magenta, go to red
					{
						color = RED;
					}
				}
			}
		}
		
		//led_write(q,0,0,0x0fff);
		//led_write((q-1), 0, 0, 0);
		//REG_PORT_OUTTGL0 = PORT_PA17;
	}
}


void SysTick_Handler ()
{
	millis++;
}

